# Product Requirement Document: SpicyDiff (ğŸŒ¶ï¸ è¾›è¾£å·®åˆ†)

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | çŠ¶æ€ | å¤‡æ³¨ |
| --- | --- | --- | --- | --- |
| v1.0 | 2024-05-20 | AI Team | Draft | åˆå§‹ MVP å®šä¹‰ |

## 1. é¡¹ç›®æ¦‚è¿° (Project Overview)

**SpicyDiff** æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥å·¥å…·ï¼Œä»¥ GitHub Action çš„å½¢å¼é›†æˆåœ¨ CI/CD æµç¨‹ä¸­ã€‚

ä¸ä¼ ç»Ÿçš„é™æ€ä»£ç åˆ†æå·¥å…·ï¼ˆå¦‚ SonarQubeï¼‰ä¸åŒï¼ŒSpicyDiff ä¸ä»…å…³æ³¨ä»£ç é€»è¾‘ï¼Œæ›´ä¾§é‡äº**äººæ ¼åŒ–çš„äº¤äº’ä½“éªŒ**ã€‚å®ƒèƒ½å¤Ÿæ ¹æ®é…ç½®ï¼Œæ‰®æ¼”â€œæ¯’èˆŒä¸»å¨â€æˆ–â€œå¤¸å¤¸ç¾¤ç¾¤ä¸»â€ä¸¤ç§æç«¯è§’è‰²ï¼Œå¯¹ä»£ç å˜æ›´ï¼ˆDiffï¼‰è¿›è¡Œè¯„è®ºï¼Œæ—¨åœ¨ä¸ºæ¯ç‡¥çš„ä»£ç å®¡æŸ¥è¿‡ç¨‹å¢åŠ è¶£å‘³æ€§ä¸ä¼ æ’­æ€§ï¼ŒåŒæ—¶æŒ‡å‡ºä»£ç ä¸­çš„â€œåå‘³é“â€æˆ–äº®ç‚¹ã€‚

### 1.1 æ ¸å¿ƒä»·å€¼

* **æƒ…ç»ªä»·å€¼**ï¼šé€šè¿‡å¹½é»˜æˆ–èµç¾çš„æ–¹å¼ç¼“è§£ Code Review çš„ç´§å¼ æ„Ÿã€‚
* **ä»£ç è´¨é‡**ï¼šåˆ©ç”¨ LLM è¯†åˆ«æ½œåœ¨çš„é€»è¾‘æ¼æ´ã€å‘½åä¸è§„èŒƒå’Œåæ¨¡å¼ã€‚
* **è‡ªåŠ¨åŒ–**ï¼šæ— ç¼é›†æˆ GitHub Pull Request æµç¨‹ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

---

## 2. ç”¨æˆ·è§’è‰² (User Personas)

* **Repository Maintainer (ä»“åº“ç»´æŠ¤è€…)**ï¼šå¸Œæœ›åœ¨å›¢é˜Ÿä¸­å¼•å…¥æœ‰è¶£çš„å·¥å…·ï¼Œæ´»è·ƒå¼€å‘æ°”æ°›ï¼ŒåŒæ—¶è¿›è¡ŒåŸºç¡€çš„ä»£ç è´¨é‡æŠŠå…³ã€‚
* **Developer (å¼€å‘è€…)**ï¼šæäº¤ PR åï¼Œå¸Œæœ›å¾—åˆ°å¿«é€Ÿåé¦ˆï¼ˆå³ä½¿æ˜¯è¢«å˜²è®½ï¼‰ï¼Œäº«å—ä¸ AI äº’åŠ¨çš„ä¹è¶£ã€‚

---

## 3. åŠŸèƒ½éœ€æ±‚ (Functional Requirements)

### 3.1 æ ¸å¿ƒæ¨¡å¼ (Modes)

ç³»ç»Ÿéœ€æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶åˆ‡æ¢ä»¥ä¸‹ä¸¤ç§æ¨¡å¼ï¼š

| æ¨¡å¼åç§° | ä»£å· | æè¿° | å‚è€ƒäººæ ¼ |
| --- | --- | --- | --- |
| **åœ°ç‹±å¨æˆ¿æ¨¡å¼** | `ROAST` | æåº¦æŒ‘å‰”ï¼Œå°–é…¸åˆ»è–„ï¼Œä½¿ç”¨é£Ÿç‰©/å¨æˆ¿æ¯”å–»æ‰¹è¯„ä»£ç ã€‚ | Gordon Ramsay |
| **å¤¸å¤¸ç¾¤æ¨¡å¼** | `PRAISE` | ç›²ç›®ä¹è§‚ï¼Œè¿‡åº¦è§£è¯»ï¼Œä½¿ç”¨å¤§é‡ Emoji èµç¾ä»£ç ã€‚ | é‡‘æ¯›å¯»å›çŠ¬ / å¤¸å¤¸ç¾¤ä¸» |

### 3.2 å®¡æŸ¥æµç¨‹ (Workflow)

1. **è§¦å‘**ï¼šç›‘å¬ GitHub Pull Request çš„ `opened` æˆ– `synchronize` äº‹ä»¶ã€‚
2. **è·å–å·®å¼‚**ï¼šæå– PR ä¸­çš„ `git diff` æ–‡æœ¬ï¼ˆå¿½ç•¥é”æ–‡ä»¶ã€å›¾ç‰‡ç­‰éä»£ç èµ„æºï¼‰ã€‚
3. **LLM åˆ†æ**ï¼šå°† Diff å†…å®¹ä¸é€‰å®šçš„ Persona Prompt ç»“åˆï¼Œå‘é€ç»™ LLMã€‚
4. **ç”Ÿæˆè¯„è®º**ï¼šè§£æ LLM è¿”å›çš„ JSON æ•°æ®ã€‚
5. **å‘å¸ƒåé¦ˆ**ï¼š
* åœ¨ PR é¡µé¢å‘å¸ƒä¸€æ¡ **Summary Comment**ï¼ˆæ€»ä½“è¯„åˆ† + æ¯’èˆŒ/å¤¸å¥–æ€»ç»“ï¼‰ã€‚
* åœ¨å…·ä½“çš„ä»£ç è¡Œå‘å¸ƒ **Inline Comments**ï¼ˆé’ˆå¯¹ç‰¹å®šé€»è¾‘çš„è¯„ä»·ï¼‰ã€‚



### 3.3 é…ç½®é¡¹ (Inputs)

ç”¨æˆ·åº”èƒ½åœ¨ `.github/workflows/*.yml` ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

* `github-token`: GitHub æƒé™ä»¤ç‰Œã€‚
* `openai-api-key`: LLM æœåŠ¡å•†çš„ API Keyã€‚
* `model`: æŒ‡å®šæ¨¡å‹ï¼ˆé»˜è®¤ `gpt-4o` æˆ– `deepseek-chat`ï¼‰ã€‚
* `mode`: `ROAST` æˆ– `PRAISE`ã€‚
* `language`: è¾“å‡ºè¯­è¨€ (`zh` / `en`)ã€‚

---

## 4. æŠ€æœ¯æ¶æ„ (Technical Architecture)

### 4.1 æŠ€æœ¯æ ˆ

* **è¯­è¨€**: Python 3.9+
* **åŸºç¡€é•œåƒ**: `python:3.9-slim`
* **æ ¸å¿ƒä¾èµ–åº“**:
* `PyGithub`: GitHub API äº¤äº’ã€‚
* `openai`: LLM æ¥å£è°ƒç”¨ã€‚
* `unidiff`: è§£æ Git diff æ ¼å¼ã€‚
* `pydantic`: æ•°æ®ç»“æ„éªŒè¯ï¼ˆå¯é€‰ï¼‰ã€‚



### 4.2 æ•°æ®æµå›¾

```mermaid
graph LR
    A[GitHub Action Trigger] --> B[SpicyDiff Container]
    B --> C{Get PR Diff}
    C --> D[Construct Prompt]
    D --> E[Call LLM API]
    E -- JSON Response --> F[Parse Comments]
    F --> G[Post to GitHub PR]

```

---

## 5. è¯¦ç»†è®¾è®¡ï¼šPrompt Engineering

ä¸ºäº†ä¿è¯è¾“å‡ºçš„ç¨³å®šæ€§å’Œè¶£å‘³æ€§ï¼Œéœ€ä¸¥æ ¼å®šä¹‰ System Promptã€‚

### 5.1 é€šç”¨çº¦æŸ (System Context)

> ä½ æ˜¯ä¸€ä¸ªä»£ç å®¡æŸ¥åŠ©æ‰‹ã€‚ä½ çš„è¾“å‡ºå¿…é¡»ä¸¥æ ¼éµå¾ª JSON æ ¼å¼ã€‚ä¸è¦è¾“å‡ºä»»ä½• Markdown ä»£ç å—æ ‡è®°ï¼ˆå¦‚ ```jsonï¼‰ï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬ JSONã€‚

### 5.2 æ¨¡å¼ A: ROAST (åœ°ç‹±å¨æˆ¿)

```text
è§’è‰²è®¾å®šï¼šä½ æ˜¯ä¸€ä¸ªè„¾æ°”æå…¶æš´èºã€æ‹¥æœ‰20å¹´ç»éªŒçš„èµ„æ·±æ¶æ„å¸ˆï¼ˆGordon Ramsay é£æ ¼ï¼‰ã€‚
ä»»åŠ¡ï¼šå®¡æŸ¥ä»£ç  Diffï¼Œå¯»æ‰¾åå‘³é“ï¼ˆMagic Number, åµŒå¥—è¿‡æ·±, å‘½åéšæ„ç­‰ï¼‰ã€‚
é£æ ¼è¦æ±‚ï¼š
1. æå°½å°–é…¸åˆ»è–„ï¼Œä½¿ç”¨ä¾®è¾±æ€§çš„å¨æˆ¿æ¯”å–»ï¼ˆå¦‚â€œè¿™ä»£ç åƒæ²¡ç…®ç†Ÿçš„æƒ çµé¡¿ç‰›æ’ä¸€æ ·ç”Ÿï¼â€ï¼‰ã€‚
2. å³ä½¿ä»£ç æ²¡æœ‰å¤§é—®é¢˜ï¼Œä¹Ÿè¦æŒ‘å‰”æ ¼å¼ã€‚
3. è¯­è¨€ï¼š{language}ã€‚

JSON è¾“å‡ºç»“æ„ï¼š
{
  "summary": "ä¸€æ®µç®€çŸ­çš„ã€æå…·æ”»å‡»æ€§çš„æ€»ä½“è¯„ä»·",
  "score": "0-100é—´çš„æ•´æ•°ï¼ˆé€šå¸¸ç»™å¾ˆä½ï¼‰",
  "reviews": [
    {
      "file_path": "æ–‡ä»¶å",
      "line_number": è¡Œå·,
      "comment": "é’ˆå¯¹è¿™ä¸€è¡Œçš„å…·ä½“å˜²è®½"
    }
  ]
}

```

### 5.3 æ¨¡å¼ B: PRAISE (å¤¸å¤¸ç¾¤)

```text
è§’è‰²è®¾å®šï¼šä½ æ˜¯ä¸€ä¸ªå¯¹ä»»ä½•äº‹ç‰©éƒ½å……æ»¡æ¿€æƒ…çš„åˆçº§å¼€å‘è€…ï¼Œä¹Ÿæ˜¯å¤¸å¤¸ç¾¤ç¾¤ä¸»ã€‚
ä»»åŠ¡ï¼šå®¡æŸ¥ä»£ç  Diffï¼Œå¯»æ‰¾ä»»ä½•ç»†å¾®çš„äº®ç‚¹ã€‚
é£æ ¼è¦æ±‚ï¼š
1. ç›²ç›®å´‡æ‹œï¼ŒæŠŠç®€å•çš„é€»è¾‘å¹æ§æˆå¤©æ‰çš„ç®—æ³•ã€‚
2. ä½¿ç”¨å¤§é‡ Emoji (âœ¨, ğŸš€, ğŸ‰, ğŸ’–)ã€‚
3. è¯­è¨€ï¼š{language}ã€‚

JSON è¾“å‡ºç»“æ„ï¼šåŒä¸Šï¼ˆScore é€šå¸¸ç»™ 90-100+ï¼‰ã€‚

```

---

## 6. æ¥å£å®šä¹‰ (LLM Output Schema)

LLM è¿”å›çš„æ•°æ®å¿…é¡»ç¬¦åˆä»¥ä¸‹ JSON Schemaï¼Œä»¥ä¾¿ç¨‹åºè§£æï¼š

```json
{
  "type": "object",
  "properties": {
    "summary": { "type": "string", "description": "PR çš„æ€»ä½“è¯„ä»·" },
    "score": { "type": "integer", "description": "ä»£ç è¯„åˆ† 0-100" },
    "reviews": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "file_path": { "type": "string" },
          "line_number": { "type": "integer" },
          "comment": { "type": "string" }
        }
      }
    }
  }
}

```

---

## 7. å¼€å‘é‡Œç¨‹ç¢‘ (Roadmap)

### Phase 1: MVP (æœ€å°å¯è¡Œæ€§äº§å“)

* [ ] å®Œæˆ Python è„šæœ¬ï¼Œæ”¯æŒæœ¬åœ°è¯»å– diff æ–‡ä»¶å¹¶è°ƒç”¨ OpenAI APIã€‚
* [ ] å®ç° Prompt æ¨¡æ¿çš„åŠ¨æ€å¡«å……ã€‚
* [ ] å®ç° GitHub API è¯„è®ºå›å†™åŠŸèƒ½ã€‚
* [ ] å°è£… Docker é•œåƒã€‚

### Phase 2: Action å‘å¸ƒ

* [ ] ç¼–å†™ `action.yml` æè¿°æ–‡ä»¶ã€‚
* [ ] å‘å¸ƒåˆ° GitHub Marketplaceã€‚
* [ ] å¢åŠ  DeepSeek / Claude æ¨¡å‹æ”¯æŒã€‚

### Phase 3: è¶£å‘³æ€§å¢å¼º (Bonus)

* [ ] **Meme ç”Ÿæˆå™¨**ï¼šæ ¹æ®è¯„åˆ†è‡ªåŠ¨é…ä¸€å¼ æ¢—å›¾ï¼ˆå¦‚ Trash Bin æˆ– Fireworksï¼‰ã€‚
* [ ] **è¯­éŸ³è¯„è®º**ï¼šç”Ÿæˆ TTS éŸ³é¢‘æ–‡ä»¶é“¾æ¥ï¼Œæ¨¡æ‹Ÿéª‚äºº/å¤¸äººçš„è¯­éŸ³ã€‚

---

## 8. ä½¿ç”¨ç¤ºä¾‹ (Usage Example)

åœ¨ç›®æ ‡ä»“åº“çš„ `.github/workflows/spicydiff.yml` ä¸­é…ç½®ï¼š

```yaml
name: SpicyDiff Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run SpicyDiff
        uses: your-name/spicydiff@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          mode: "ROAST" # å¼€å¯æ¯’èˆŒæ¨¡å¼
          language: "zh"

```